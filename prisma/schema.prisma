// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===================================
// 1. MODELO USER (O Dono da Conta)
// ===================================
model User {
  id               String       @id @default(uuid())
  email            String       @unique
  password         String
  name             String
  document         String?
  role             String       @default("USER") // USER, SUPPORT, ADMIN
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  
  balance          Int          @default(0) 

  apiKey           String       @unique 
  apiSecret        String       @unique 

  // üéØ NOVO: 2FA
  twoFactorEnabled Boolean      @default(false)
  twoFactorMethod  String?      // 'EMAIL' ou 'GOOGLE_AUTH'
  twoFactorSecret  String?      // Para Google Authenticator
  
  // Rela√ß√µes
  merchant         Merchant?
  deposits         Deposit[]
  withdrawals      Withdrawal[]
  pushSubscriptions PushSubscription[]
  passwordResets   PasswordReset[] // üéØ NOVO
  twoFactorCodes   TwoFactorCode[] // üéØ NOVO
  memberAccesses   MemberAccess[]  // üéØ NOVO: Acesso a √°reas de membros
}

// ===================================
// üéØ NOVO: PASSWORD RESET
// ===================================
model PasswordReset {
  id               String       @id @default(uuid())
  userId           String
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  token            String       @unique
  expiresAt        DateTime
  used             Boolean      @default(false)
  
  createdAt        DateTime     @default(now())
  
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

// ===================================
// üéØ NOVO: TWO FACTOR CODE (Para 2FA por Email)
// ===================================
model TwoFactorCode {
  id               String       @id @default(uuid())
  userId           String
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  code             String       // C√≥digo de 6 d√≠gitos
  expiresAt        DateTime
  used             Boolean      @default(false)
  
  createdAt        DateTime     @default(now())
  
  @@index([userId])
  @@index([code])
  @@index([expiresAt])
}

// ===================================
// üìî MODELO PUSH SUBSCRIPTION
// ===================================
model PushSubscription {
  id               String       @id @default(uuid())
  userId           String
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  endpoint         String       @unique
  p256dh           String
  auth             String
  
  deviceInfo       String?
  isActive         Boolean      @default(true)
  
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  
  @@index([userId])
}

// ===================================
// 2. MODELO MERCHANT (A Loja / O Seller)
// ===================================
model Merchant {
  id               String       @id @default(uuid())
  storeName        String
  cnpj             String       @unique
  logoUrl          String?
  pixKey           String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  user             User         @relation(fields: [userId], references: [id])
  userId           String       @unique

  products         Product[]
  paymentLinks     PaymentLink[]
  deposits         Deposit[]
  integrations     MembershipIntegration[]
  subscriptionPlans SubscriptionPlan[]
  memberAreas      MemberArea[] // üéØ NOVO: √Åreas de membros do seller
}

// ===================================
// üéØ NOVO: MEMBER AREA (√Årea de Membros Estilo Netflix)
// ===================================
model MemberArea {
  id               String       @id @default(uuid())
  merchantId       String
  merchant         Merchant     @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  
  name             String       // Ex: "Curso de Marketing Avan√ßado"
  slug             String       @unique // Ex: "marketing-avancado"
  description      String?
  coverImageUrl    String?      // Imagem de capa estilo Netflix
  logoUrl          String?
  
  isActive         Boolean      @default(true)
  
  // Configura√ß√µes visuais
  primaryColor     String       @default("#9333ea")
  secondaryColor   String       @default("#06b6d4")
  
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  
  // Rela√ß√µes
  contents         MemberContent[]
  accesses         MemberAccess[]
  
  @@index([merchantId])
  @@index([slug])
}

// ===================================
// üéØ NOVO: MEMBER CONTENT (Conte√∫do da √Årea de Membros)
// ===================================
model MemberContent {
  id               String       @id @default(uuid())
  memberAreaId     String
  memberArea       MemberArea   @relation(fields: [memberAreaId], references: [id], onDelete: Cascade)
  
  title            String
  description      String?
  type             String       // 'VIDEO', 'PDF', 'AUDIO', 'TEXT', 'EXTERNAL_LINK'
  contentUrl       String?      // URL do v√≠deo, PDF, etc
  thumbnailUrl     String?
  
  order            Int          @default(0)
  duration         Int?         // Dura√ß√£o em segundos (para v√≠deos)
  
  isPublic         Boolean      @default(false) // Se true, n√£o precisa estar logado
  
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  
  @@index([memberAreaId])
  @@index([order])
}

// ===================================
// üéØ NOVO: MEMBER ACCESS (Controle de Acesso)
// ===================================
model MemberAccess {
  id               String       @id @default(uuid())
  
  userId           String
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  memberAreaId     String
  memberArea       MemberArea   @relation(fields: [memberAreaId], references: [id], onDelete: Cascade)
  
  // Como o acesso foi concedido
  grantedBy        String       // 'MANUAL', 'HOTMART', 'KIWIFY', 'PURCHASE'
  externalId       String?      // ID da transa√ß√£o externa (Hotmart, etc)
  
  expiresAt        DateTime?    // null = acesso vital√≠cio
  isActive         Boolean      @default(true)
  
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  
  @@unique([userId, memberAreaId])
  @@index([userId])
  @@index([memberAreaId])
  @@index([expiresAt])
}

// ===================================
// 3. MODELO PRODUCT (O Produto Digital)
// ===================================
model Product {
  id               String       @id @default(uuid())
  name             String
  description      String?
  priceInCents     Int
  isAvailable      Boolean      @default(true)
  
  merchant         Merchant     @relation(fields: [merchantId], references: [id])
  merchantId       String
  
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  paymentLinks     PaymentLink[]
  marketplaceProduct MarketplaceProduct?
}

// ===================================
// 4. MODELO PAYMENT LINK
// ===================================
model PaymentLink {
  id               String       @id @default(uuid())
  slug             String       @unique
  name             String
  amountInCents    Int
  isActive         Boolean      @default(true)
  sellerFeeRate    Float        @default(0) 
  
  product          Product      @relation(fields: [productId], references: [id])
  productId        String
  
  merchant         Merchant     @relation(fields: [merchantId], references: [id])
  merchantId       String

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  
  deposits         Deposit[]
}

// ===================================
// 5. MODELO DEPOSIT (O Pagamento PIX)
// ===================================
model Deposit {
  id                   String      @id @default(uuid())
  externalId           String      @unique
  amountInCents        Int
  feeInCents           Int         @default(0)
  sellerFeeInCents     Int         @default(0)
  netAmountInCents     Int
  status               String      @default("PENDING")
  
  payerName            String
  payerEmail           String
  payerDocument        String
  webhookToken         String      @unique
 
  user                 User        @relation(fields: [userId], references: [id])
  userId               String

  merchant             Merchant?   @relation(fields: [merchantId], references: [id])
  merchantId           String?
  
  paymentLink          PaymentLink? @relation(fields: [paymentLinkId], references: [id])
  paymentLinkId        String?

  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt
}

// ===================================
// 6. MODELO WITHDRAWAL (O Saque PIX)
// ===================================
model Withdrawal {
  id               String       @id @default(uuid())
  userId           String
  user             User         @relation(fields: [userId], references: [id])
  
  amount           Int          // Valor SOLICITADO (com taxa)
  netAmount        Int          @default(0) // Valor L√çQUIDO (sem taxa)
  feeAmount        Int          @default(0) // Taxa cobrada (8% + R$2)
  
  status           String       @default("PENDING")
  pixKey           String    
  keyType          String
  description      String?
  externalId       String       @unique
  webhookToken     String?      @unique
  
  failureReason    String?
  
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// ===================================
// 7. MODELO MEMBERSHIP INTEGRATION
// ===================================
model MembershipIntegration {
  id               String       @id @default(uuid())
  name             String
  webhookUrl       String
  platform         String       // 'HOTMART', 'KIWIFY', 'EDUZZ', etc
  secretKey        String?

  merchant         Merchant     @relation(fields: [merchantId], references: [id])
  merchantId       String

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
}

// ===================================
// 8. MODELO MARKETPLACE PRODUCT
// ===================================
model MarketplaceProduct {
  id               String       @id @default(uuid())
  commissionRate   Float        
  status           String       @default("AVAILABLE") 
  attributionType  String       @default("LAST_CLICK") 

  product          Product      @relation(fields: [productId], references: [id])
  productId        String       @unique

  affiliates       Affiliate[]

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
}

// ===================================
// 9. MODELO AFFILIATE
// ===================================
model Affiliate {
  id               String       @id @default(uuid())
  promoterId       String       
  marketplaceProductId String
  marketplaceProduct   MarketplaceProduct @relation(fields: [marketplaceProductId], references: [id])
  status           String       @default("APPROVED") 

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  
  @@unique([promoterId, marketplaceProductId])
}

// ===================================
// 10. MODELO SUBSCRIPTION PLAN
// ===================================
model SubscriptionPlan {
  id               String       @id @default(uuid())
  name             String
  interval         String
  priceInCents     Int
  trialPeriodDays  Int          @default(0)
  
  merchant         Merchant     @relation(fields: [merchantId], references: [id])
  merchantId       String

  subscriptions    Subscription[]

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  
  @@unique([merchantId, name])
}

// ===================================
// 11. MODELO SUBSCRIPTION (Assinatura Ativa do Cliente)
// ===================================
model Subscription {
  id               String       @id @default(uuid())
  subscriberEmail  String       
  subscriberName   String       
  status           String       @default("ACTIVE") 
  nextBillingDate  DateTime     
  gatewaySubscriptionId String?
  
  plan             SubscriptionPlan @relation(fields: [planId], references: [id])
  planId           String

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
}