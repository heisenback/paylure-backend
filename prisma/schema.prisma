generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===================================
// 1. MODELO USER
// ===================================
model User {
  id                   String       @id @default(uuid())
  email                String       @unique
  password             String
  name                 String
  document             String?
  phone                String?
  role                 String       @default("USER")
  
  // ‚úÖ NOVA FLAG: MEMBRO FUNDADOR (Para quem entrar no lan√ßamento ou nos 100 primeiros)
  isFounder            Boolean      @default(false)

  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt
  
  balance              Int          @default(0) 

  apiKey               String       @unique 
  apiSecret            String       @unique 

  // --- TAXAS DE SAQUE ---
  withdrawalFeePercent Float?       @default(0.0)
  withdrawalFeeFixed   Int?         @default(0)
  isAutoWithdrawal     Boolean      @default(false)

  // --- ‚úÖ NOVAS TAXAS DE VENDA (AUTOM√ÅTICAS) ---
  transactionFeePercent Float       @default(8.0) // Padr√£o 8%
  transactionFeeFixed   Int         @default(200) // Padr√£o 200 cents (R$ 2,00)

  // --- ‚úÖ SISTEMA DE INDICA√á√ÉO (REFERRAL) ---
  referralCode         String       @unique @default(cuid())
  referredById         String?      
  referredBy           User?        @relation("UserReferrals", fields: [referredById], references: [id])
  referrals            User[]       @relation("UserReferrals")
  
  referralCommissionRate Float      @default(0.01) // 1%
  referralEndsAt       DateTime?    // Data limite da comiss√£o

  // --- SEGURAN√áA ---
  twoFactorEnabled     Boolean      @default(false)
  twoFactorMethod      String?      @default("APP")
  twoFactorSecret      String?
  
  // --- RELA√á√ïES ---
  merchant             Merchant?
  deposits             Deposit[]
  withdrawals          Withdrawal[]
  pushSubscriptions    PushSubscription[]
  passwordResets       PasswordReset[]
  twoFactorCodes       TwoFactorCode[]
  memberAccesses       MemberAccess[]
  transactions         Transaction[]
  pixels               Pixel[]
  lessonProgress       LessonProgress[]
  comments             Comment[]
}

// ===================================
// üéØ SYSTEM SETTINGS
// ===================================
model SystemSettings {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([key])
}

// ===================================
// üéØ PASSWORD RESET
// ===================================
model PasswordReset {
  id               String       @id @default(uuid())
  userId           String
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  token            String       @unique
  expiresAt        DateTime
  used             Boolean      @default(false)
  createdAt        DateTime     @default(now())
  
  @@index([userId])
  @@index([token])
}

// ===================================
// üéØ TWO FACTOR CODE
// ===================================
model TwoFactorCode {
  id               String       @id @default(uuid())
  userId           String
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  code             String       
  expiresAt        DateTime
  used             Boolean      @default(false)
  createdAt        DateTime     @default(now())
  
  @@index([userId])
  @@index([code])
}

// ===================================
// üîî PUSH SUBSCRIPTION
// ===================================
model PushSubscription {
  id               String       @id @default(uuid())
  userId           String
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  endpoint         String       @unique
  p256dh           String
  auth             String
  deviceInfo       String?
  isActive         Boolean      @default(true)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  
  @@index([userId])
}

// ===================================
// 2. MODELO MERCHANT
// ===================================
model Merchant {
  id               String       @id @default(uuid())
  storeName        String
  cnpj             String       @unique
  logoUrl          String?
  pixKey           String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  user             User         @relation(fields: [userId], references: [id])
  userId           String       @unique

  products         Product[]
  paymentLinks     PaymentLink[]
  deposits         Deposit[]
  integrations     MembershipIntegration[]
  subscriptionPlans SubscriptionPlan[]
  memberAreas      MemberArea[]
}

// ===================================
// üéØ MEMBER AREA
// ===================================
model MemberArea {
  id               String       @id @default(uuid())
  merchantId       String
  merchant         Merchant     @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  name             String 
  slug             String       @unique 
  description      String?
  coverImageUrl    String?      
  logoUrl          String?
  isActive         Boolean      @default(true)
  primaryColor     String       @default("#9333ea")
  secondaryColor   String       @default("#06b6d4")
  allowComments    Boolean      @default(true)

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  
  modules          MemberModule[] 
  contents         MemberContent[]
  accesses         MemberAccess[]
  products         Product[]    
  
  @@index([merchantId])
  @@index([slug])
}

// ===================================
// üìÇ MEMBER MODULE
// ===================================
model MemberModule {
  id           String          @id @default(uuid())
  memberAreaId String
  memberArea   MemberArea      @relation(fields: [memberAreaId], references: [id], onDelete: Cascade)
  title        String
  order        Int             @default(0)
  
  contents     MemberContent[] 
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  @@index([memberAreaId])
}

// ===================================
// üéØ MEMBER CONTENT (AULA)
// ===================================
model MemberContent {
  id               String       @id @default(uuid())
  memberAreaId     String
  memberArea       MemberArea   @relation(fields: [memberAreaId], references: [id], onDelete: Cascade)
  
  moduleId         String?
  module           MemberModule? @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  title            String
  description      String?      @db.Text
  type             String       
  contentUrl       String?
  thumbnailUrl     String?
  textBody         String?      @db.Text
  
  releaseDays      Int          @default(0) 
  attachments      Json?
  order            Int          @default(0)
  duration         Int?
  isPublic         Boolean      @default(false) 
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  
  progress         LessonProgress[]
  comments         Comment[]

  @@index([memberAreaId])
  @@index([moduleId])
  @@index([order])
}

// ===================================
// ‚úÖ LESSON PROGRESS
// ===================================
model LessonProgress {
  id        String        @id @default(uuid())
  userId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  contentId String
  content   MemberContent @relation(fields: [contentId], references: [id], onDelete: Cascade)
  
  completed Boolean       @default(true)
  updatedAt DateTime      @updatedAt

  @@unique([userId, contentId])
}

// ===================================
// ‚úÖ COMMENT
// ===================================
model Comment {
  id        String        @id @default(uuid())
  text      String        @db.Text
  
  userId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  contentId String
  content   MemberContent @relation(fields: [contentId], references: [id], onDelete: Cascade)
  
  createdAt DateTime      @default(now())
  
  @@index([contentId])
}

// ===================================
// üéØ MEMBER ACCESS
// ===================================
model MemberAccess {
  id               String       @id @default(uuid())
  userId           String
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  memberAreaId     String
  memberArea       MemberArea   @relation(fields: [memberAreaId], references: [id], onDelete: Cascade)
  grantedBy        String       @default("PURCHASE") 
  externalId       String?
  expiresAt        DateTime?
  isActive         Boolean      @default(true)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  
  @@unique([userId, memberAreaId])
  @@index([userId])
}

// ===================================
// 3. MODELO PRODUCT
// ===================================
model Product {
  id               String       @id @default(uuid())
  name             String
  description      String?
  priceInCents     Int
  isAvailable      Boolean      @default(true)
  imageUrl         String?
  category         String?      @default("WEALTH")
  salesPageUrl     String?
  deliveryMethod   String       @default("PAYLURE_MEMBERS")
  paymentType      String       @default("ONE_TIME")
  subscriptionPeriod String?
  deliveryUrl      String?
  fileUrl          String?
  fileName         String?
  content          Json?
  checkoutConfig   Json?
  isAffiliationEnabled Boolean  @default(false)
  showInMarketplace    Boolean  @default(false)
  commissionPercent    Float?   @default(0)
  affiliationType      String?  @default("OPEN")
  materialLink         String?
  coproductionEmail    String?
  coproductionPercent  Float?   @default(0)
  offers           Offer[]      
  coupons          Coupon[]     
  merchant         Merchant     @relation(fields: [merchantId], references: [id])
  merchantId       String
  memberAreaId     String?
  memberArea       MemberArea?  @relation(fields: [memberAreaId], references: [id])
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  paymentLinks     PaymentLink[]
  marketplaceProduct MarketplaceProduct?
  transactions     Transaction[]
  
  @@index([merchantId])
  @@index([deliveryMethod])
  @@index([memberAreaId])
}

// MODELO: OFERTAS EXTRAS
model Offer {
  id            String   @id @default(uuid())
  name          String   
  priceInCents  Int
  isDefault     Boolean  @default(false)
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId     String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  @@index([productId])
}

// MODELO: CUPONS
model Coupon {
  id            String   @id @default(uuid())
  code          String   
  discountPercent Int    
  isActive      Boolean  @default(true)
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId     String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([productId])
  @@index([code])
}

// ===================================
// 4. MODELO PAYMENT LINK
// ===================================
model PaymentLink {
  id               String       @id @default(uuid())
  slug             String       @unique
  name             String
  amountInCents    Int
  isActive         Boolean      @default(true)
  sellerFeeRate    Float        @default(0) 
  product          Product      @relation(fields: [productId], references: [id])
  productId        String
  merchant         Merchant     @relation(fields: [merchantId], references: [id])
  merchantId       String
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
 
  deposits         Deposit[]
}

// ===================================
// 5. MODELO DEPOSIT
// ===================================
model Deposit {
  id                   String      @id @default(uuid())
  externalId           String      @unique
  amountInCents        Int
  feeInCents           Int         @default(0)
  sellerFeeInCents     Int         @default(0)
  netAmountInCents     Int
  status               String      @default("PENDING")
  payerName            String
  payerEmail           String
  payerDocument        String
  webhookToken         String      @unique
  user                 User        @relation(fields: [userId], references: [id])
  userId               String
  merchant             Merchant?   @relation(fields: [merchantId], references: [id])
  merchantId           String?
  paymentLink          PaymentLink? @relation(fields: [paymentLinkId], references: [id])
  paymentLinkId        String?
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt
}

// ===================================
// 6. MODELO WITHDRAWAL
// ===================================
model Withdrawal {
  id               String       @id @default(uuid())
  userId           String
  user             User         @relation(fields: [userId], references: [id])
  amount           Int          
  netAmount        Int          @default(0) 
  feeAmount        Int          @default(0) 
  status           String       @default("PENDING")
  pixKey           String    
  keyType          String
  description      String?
  externalId       String       @unique
  webhookToken     String?      @unique
  failureReason    String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  @@index([userId])
  @@index([status])
}

// ===================================
// 7. MEMBERSHIP INTEGRATION
// ===================================
model MembershipIntegration {
  id               String       @id @default(uuid())
  name             String
  webhookUrl       String
  platform         String       
  secretKey        String?
  merchant         Merchant     @relation(fields: [merchantId], references: [id])
  merchantId       String
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
}

// ===================================
// 8. MARKETPLACE PRODUCT
// ===================================
model MarketplaceProduct {
  id               String       @id @default(uuid())
  commissionRate   Float      
  status           String       @default("AVAILABLE") 
  attributionType  String       @default("LAST_CLICK") 
  product          Product      @relation(fields: [productId], references: [id])
  productId        String       @unique
  affiliates       Affiliate[]
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
}

// ===================================
// 9. AFFILIATE
// ===================================
model Affiliate {
  id               String       @id @default(uuid())
  promoterId       String       
  marketplaceProductId String
  marketplaceProduct   MarketplaceProduct @relation(fields: [marketplaceProductId], references: [id])
  status           String       @default("APPROVED") 
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  @@unique([promoterId, marketplaceProductId])
}

// ===================================
// 10. SUBSCRIPTION PLAN
// ===================================
model SubscriptionPlan {
  id               String       @id @default(uuid())
  name             String
  interval         String
  priceInCents     Int
  trialPeriodDays  Int          @default(0)
  merchant         Merchant     @relation(fields: [merchantId], references: [id])
  merchantId       String
  subscriptions    Subscription[]
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  @@unique([merchantId, name])
}

// ===================================
// 11. SUBSCRIPTION
// ===================================
model Subscription {
  id               String       @id @default(uuid())
  subscriberEmail  String       
  subscriberName   String       
  status           String       @default("ACTIVE") 
  nextBillingDate  DateTime     
  gatewaySubscriptionId String?
  plan             SubscriptionPlan @relation(fields: [planId], references: [id])
  planId           String
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
}

// ===================================
// 12. TRANSACTION (Extrato Unificado)
// ===================================
model Transaction {
  id               String       @id @default(uuid())
  userId           String
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId        String?
  product          Product?     @relation(fields: [productId], references: [id])
  type             String
  amount           Int
  description      String?
  status           String       @default("PENDING")
  customerName     String?
  customerEmail    String?
  customerDoc      String?
  customerPhone    String?
  paymentMethod    String?
  pixQrCode        String?      @db.Text
  pixCopyPaste     String?      @db.Text
  externalId       String?
  referenceId      String?
  referenceType    String?
  metadata         Json?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

// ===================================
// 13. PIXEL & TRACKING
// ===================================
model Pixel {
  id          String   @id @default(uuid())
  name        String
  platform    String   // FACEBOOK, GOOGLE, TIKTOK, etc.
  pixelId     String
  accessToken String?
  testCode    String?
  active      Boolean  @default(true)
  events      Json     
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  @@index([userId])
}